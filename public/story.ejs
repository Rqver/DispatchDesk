<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= story.title %> | Dispatch Desk</title>
    <%- include('partials/_theme-apply') %>
    <link href="/css/tailwind.css" rel="stylesheet" />
    <script defer src="https://stats.dispatchdesk.nz/script.js" data-website-id="44342af3-5f64-4ae3-9248-b57b4706c01f"></script>
    <meta property="og:title" content="<%= story.title %>" />
    <meta property="og:site_name" content="Dispatch Desk" />
    <meta property="og:description" content="<%= story.tagline ? story.tagline : 'Dispatch Desk | Fast, Authentic News' %>" />
    <meta property="og:image" content="<%= story.header_media %>.jpeg" />
    <meta property="og:url" content="https://dispatchdesk.nz/story/<%= story.slug %>" />
    <meta property="og:type" content="article" />
    <link rel="canonical" href="https://dispatchdesk.nz/story/<%= story.slug %>" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="<%= story.title %>" />
    <meta name="twitter:description" content="<%= story.tagline ? story.tagline : 'Dispatch Desk | Fast, Authentic News' %>" />
    <meta name="twitter:image" content="<%= story.header_media %>.jpeg" />
    <meta name="description" content="<%= story.tagline %>" />
    <link
            rel="preload"
            as="image"
            href="<%= story.header_media %>&width=1000"
            fetchpriority="high"
    />
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "NewsArticle",
            "author": {
                "@type": "Organization",
                "name": "Dispatch Desk",
                "url": "https://dispatchdesk.nz/"
            },
            "headline": "<%= story.title %>",
            "image": [
                "<%= story.header_media %>.jpeg"
            ],
            "datePublished": "<%= story.publishDate %>",
            "publisher": {
                "@type": "Organization",
                "name": "Dispatch Desk",
                "url": "https://dispatchdesk.nz/"
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

<%- include('partials/_header', { featuredCategories, breakingBar }) %>

<main class="container mx-auto px-4 py-8">
    <article class="max-w-4xl mx-auto">
        <div class="mb-4">
            <% story.categories.forEach((cat, index) => { %>
                <a href="/category/<%= cat.slug %>" class="text-sm font-bold text-cyan-500 uppercase tracking-widest hover:underline">
                    <%= cat.name %>
                </a>
                <% if (index < story.categories.length - 1) { %>
                    <span class="text-gray-400"> / </span>
                <% } %>
            <% }) %>

        </div>

        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 dark:text-gray-100 mb-4 leading-tight">
            <%= story.title %>
        </h1>

        <% if (story.tagline) { %>
            <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-400 mb-6">
                <%= story.tagline %>
            </p>
        <% } %>

        <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-8 border-y border-gray-200 dark:border-gray-700 py-4">
            <% if (story.author) { %>
                <div>
                    <%- story.ai_written
                            ? (story.source_name?.trim()
                                    ? `Source: <a class="font-semibold" href="${story.original_source}" target="_blank"> ${story.source_name}</a>`
                                    : `Source: <a class="font-semibold" href="${story.original_source}" target="_blank"> ${story.original_source}</a>`)
                            : `By ${story.author}` %>
                </div>
            <% } %>
            <% if (story.publishDate) { %>
                â€¢<div data-published="<%= story.publishDate %>" class="story-date"></div>
            <% } %>
        </div>

        <% if (story.header_media) { %>
            <figure class="mb-8">
                <div class="relative w-full overflow-hidden rounded shadow" style="aspect-ratio: 16 / 9;">
                    <img src="<%= story.header_media %>?format=webp&quality=70&width=1000" alt="<%= story.title %>"
                         class="absolute inset-0 w-full h-full object-cover" loading="eager">
                </div>
                <figcaption class="text-gray-500"><%= story.header_caption %></figcaption>
            </figure>
        <% } %>

        <div id="live-blog-container">
            <%- include('partials/_live-blog', { liveBlog: story.liveBlog }) %>
        </div>

        <div class="prose prose-lg dark:prose-invert max-w-none">
            <%- story.body %>
        </div>

        <% if (story.ai_written && story.original_source) { %>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-6 italic">
            This article was originally written by AI. You can view the original source <a target="_blank" href="<%= story.original_source %>" class="underline hover:text-cyan-500">here</a>.
        </p>
        <% } %>

        <%- include('partials/_share-box', { story: story }) %>

    </article>
</main>

<%- include('partials/_footer') %>
<%- include('partials/_search-script') %>
<% if (story.liveBlog) { %>
    <script>
        function connectWebSocket() {
            const socket = new WebSocket('wss://dispatchdesk.nz/');

            socket.onmessage = async (event) => {
                try {
                    const message = JSON.parse(event.data);

                    if (message.type === 'live_blog_update') {

                        const response = await fetch(`/api/story/<%= story.slug %>/live-blog`);
                        if (!response.ok) return;

                        const newHtml = await response.text();
                        const container = document.getElementById('live-blog-container');

                        if (container) {
                            container.innerHTML = newHtml;
                        }
                    }
                } catch (error) {
                    console.error('Error handling WebSocket message:', error);
                }
            };

            socket.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting in 5s...');
                setTimeout(connectWebSocket, 5000);
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                socket.close();
            };
        }
        connectWebSocket();
    </script>
<% } %>
<script>
    document.querySelectorAll('.story-date').forEach(el => {
        const raw = el.dataset.published;
        if (raw) {
            const date = new Date(raw);
            el.textContent = date.toLocaleDateString("en-NZ", {
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            });
        }
    });
</script>
</body>
</html>